---
title: "Data set prep for PSOMER CAMP project"
output: html_notebook
---

# Libraries

It's important you know what each package is doing
```{r}
# for data manipulation and visualization
library(tidyverse)

# to help set the working directory and make this script reproducible across different machines
library(here)

# for the strobe diagram
library(DiagrammeR)
library(DiagrammeRsvg) 
library(glue)
library(rsvg)

# for Table one
library(tableone) 
```

## check the working directory- this should be the filepath to your project folder

```{r}
here::here()
```

# Methods

## Study population and inclusion criteria

This study identifies all....

### Load in dataset

Load in your dataset for your project. For this example, I am using an example dataset from: 

https://archive.ics.uci.edu/dataset/45/heart+disease

```{r}
# you are unlikely to need col_names = FALSE
heart_data <- read_csv(here("data", "processed.cleveland.data"), col_names = FALSE)

# here I am labeling the columns- you might need to do this!
column_names <- c(
  "age", "sex", "cp", "trestbps", "chol", "fbs", "restecg",
  "thalach", "exang", "oldpeak", "slope", "ca", "thal", "num"
)

heart_data <- heart_data %>%
  setNames(column_names)
```

## Primary outcome

The primary outcome of this study is the diagnosis of "any heart disease", defined as....
```{r}
# construct binary primary outcome of any_heart_disease from num > 0
heart_data <- heart_data %>%
  mutate(any_heart_disease = ifelse(num > 0, 1, 0))
```

# Exploratory data analysis

This section won't go in your methods, but is essential to understand your dataset

### view your dataset
```{r}
heart_data
```

# Create a table one
```{r}
# Create a table one for the final cohort
table_one <- CreateTableOne(data = heart_data)

table_one
```



## Exploratory data analysis

Visualize distribution of age in the dataset
```{r}
heart_data %>%
  ggplot(aes(x = age)) +
  geom_density(fill = "blue", alpha = 0.5)
```

## calculate the mean, median, and mode of age

```{r}
mean_age <- mean(heart_data$age, na.rm = TRUE)
median_age <- median(heart_data$age, na.rm = TRUE)
mode_age <- as.numeric(names(sort(table(heart_data$age), decreasing = TRUE)[1]))
```

```{r}
mean_age
```
```{r}
median_age
```

```{r}
mode_age
```

```{r}
heart_data %>%
  ggplot(aes(x = age)) +
  geom_histogram(binwidth = 1,
                 fill = "blue", color = "black", alpha = 0.5)
```


```{r}
heart_data %>%
  group_by(any_heart_disease) %>%
  ggplot(aes(x = age, fill = factor(any_heart_disease))) +
  geom_density(alpha = 0.5)
```


## test the hypothesis that patients with heart disease are older on average

specifically test that the mean age is higher in patients with heart disease compared to those without


```{r}
mean_age_heart_disease <- heart_data %>%
  filter(any_heart_disease == 1) %>%
  summarise(mean_age = mean(age, na.rm = TRUE))

mean_age_heart_disease
```
### mean age of patients without heart disease
```{r}
mean_age_no_heart_disease <- heart_data %>%
  filter(any_heart_disease == 0) %>%
  summarise(mean_age = mean(age, na.rm = TRUE))

mean_age_no_heart_disease
```
### null hypothesis

the mean age is the same in patients with and without heart disease

mean_age_heart_disease == mean_age_no_heart_disease

### formula for a t-test in latex

$$t = \frac{\bar{X}_1 - \bar{X}_2}{s_p \sqrt{\frac{1}{n_1} + \frac{1}{n_2}}}$$


$$s_p = \sqrt{\frac{(n_1 - 1)s_1^2 + (n_2 - 1)s_2^2}{n_1 + n_2 - 2}}$$

```{r}
t_test_result <- t.test(age ~ any_heart_disease, data = heart_data)

t_test_result
```
## Unadjusted association of age with heart disease

```{r}
# Create a logistic regression model to assess the association of age with heart disease
logistic_model <- glm(any_heart_disease ~ age, data = heart_data, family = binomial)
```

```{r}
summary(logistic_model)
```
```{r}
exp(0.05199)
```

## scatterplot of age vs cholesterol
```{r}
heart_data %>%
  ggplot(aes(x = age, y = chol)) +
  geom_point() +
  labs(title = "Scatterplot of Age vs Cholesterol",
       x = "Age",
       y = "Cholesterol")
```



### adujsted logistic regression model controlling for cholesterol
```{r}
logistic_model_adjusted <- glm(any_heart_disease ~ age + chol, 
                               data = heart_data, family = binomial)
```

```{r}
summary(logistic_model_adjusted)
```


### Define inclusion criteria and filter the dataset accordingly
Track of the patients you exclude for your STROBE diagram
```{r}

```


### Exclude patients who do not meet the inclusion criteria and save them in dataset

```{r}
excluded_patients <- data %>%
  filter(inclusion == FALSE)
```




```{r}
#export to results
# Convert to data frame
table_df <- as.data.frame(print(table_one, quote = FALSE, noSpaces = TRUE))

# Write CSV
write.csv(table_df, file = here("results", "table_one.csv"), row.names = TRUE)
```

### Make a strobe flow diagram with the exclusion reasons

Use generative AI for this! Do NOT code it by hand

```{r}

```

```{r}
strobe_diagram <- grViz(glue("
digraph flowchart {{
  rankdir = TB;
  node [shape = box, style = filled, fontname = Helvetica]
  edge [fontname = Helvetica]

  A [label = 'Initial cohort\\n(n = {total_n})', fillcolor = lightgray]
    B [label = 'Excluded (n = {n_excluded})\\n{n_excl_age_low} Age < 30\\n{n_excl_age_high} Age > 70\\n{n_excl_cr_low} Creatinine < 0.5\\n{n_excl_cr_high} Creatinine > 1.5', fillcolor = lightblue]
  C [label = 'Final cohort\\n(n = {final_n})', fillcolor = lightgray]
  X [label = '', width=0, height=0, shape=point, style=invis]

  A -> X [arrowhead=none]
  X -> B
  X -> C 

  {{ rank = same; B; X }}
}}
"))

strobe_diagram
```

```{r}
#convert the DiagrammeR object to SVG
svg <- export_svg(strobe_diagram)

# Convert SVG to PDF and save it
rsvg_pdf(charToRaw(svg), here("results", "strobe_diagram.pdf"))
```



